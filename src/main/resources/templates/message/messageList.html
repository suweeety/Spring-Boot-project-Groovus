<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      layout:decorate="~{layout/basic.html}">
<head>
  <meta charset="UTF-8">
  <title>ìª½ì§€í•¨</title>
  <th:block layout:fragment="css">

    <style>

      #logoImg{
        background-color: #56c53d;
      }

      .messageTitle:hover{
        color: #0d4dff;
        cursor: pointer;
      }


    </style>

  </th:block>
</head>

<th:block layout:fragment="content">

    <div class="row page-titles mx-0">
      <div class="col p-md-0">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="javascript:void(0)">[[${projectName}]]</a></li>
          <li class="breadcrumb-item active"><a href="javascript:void(0)">ìª½ì§€í•¨</a></li>
        </ol>
      </div>
    </div>
    <!-- row -->

    <div class="container-fluid">
      <div class="row">
        <div class="col-lg-12">
          <div class="card">
            <div class="card-body">

              <div class="email-left-box"><a href="#" class="btn btn-primary btn-block" style="background-color: #56c53d;" id="sendMessage">ìª½ì§€ì“°ê¸°</a>
                <div class="mail-list mt-4">
                  <a th:href="@{'/message/list/' + ${pid}+'/'+${#authentication.principal.mid}+'/'+${projectName}}" class="list-group-item border-0 text-primary p-r-0" id="MessageBox"><i class="fa fa-inbox font-18 align-middle mr-2"></i> <b>ìª½ì§€í•¨</b> <span class="badge badge-primary badge-sm float-right m-t-5" th:name="countall">0</span> </a>
                  <a th:href="@{'/message/list/' + ${pid}+'/'+${#authentication.principal.mid}+'/'+${projectName}+'?type=s&keyword='+${#authentication.principal.mid}}" class="list-group-item border-0 p-r-0" id="sendMessageBox"><i class="fa fa-paper-plane font-18 align-middle mr-2"></i><b>ë³´ë‚¸ìª½ì§€</b></a>
                  <a th:href="@{'/message/list/' + ${pid}+'/'+${#authentication.principal.mid}+'/'+${projectName}+'?type=d&keyword='+${#authentication.principal.mid}}" class="list-group-item border-0 p-r-0" id="trashMessageBox"><i class="fa fa-trash font-18 align-middle mr-2"></i><b>íœ´ì§€í†µ</b></a>
                </div>
              </div>

              <div class="email-right-box">
                <div role="toolbar" class="toolbar">
                  <div class="btn-group">
                    <button aria-expanded="false" data-toggle="dropdown" class="btn btn-dark dropdown-toggle" type="button">More <span class="caret m-l-5"></span>
                    </button>
                    <div class="dropdown-menu"><span class="dropdown-header">More Option :</span>  <a href="javascript: void(0);" class="dropdown-item">ì¤€ë¹„ì¤‘</a>  <a href="javascript: void(0);" class="dropdown-item">ì¤€ë¹„ì¤‘</a>  <a href="javascript: void(0);" class="dropdown-item">ì¤€ë¹„ì¤‘</a>  <a href="javascript: void(0);" class="dropdown-item">ì¤€ë¹„ì¤‘</a>
                    </div>
                  </div>
                </div>

                <!--ë©”ì¸ì½˜í…ì¸ ìª½-->
                <div class="card-body" name="mainContent">

                  <div name="mainList">
                    <div class="card-title">
                      <h4>[[${#authentication.principal.uid}]]ì˜ ìª½ì§€í•¨</h4>
                    </div>
                    <div class="table-responsive" >
                      <table class="table">
                        <thead>
                        <tr>
                          <th>ğŸ“¬</th>
                          <th>ì œëª©</th>
                          <th>ì½ìŒ/ì•ˆì½ìŒ</th>
                          <th>ì „ì†¡ì¼</th>
                          <th>ë³´ë‚¸ì´</th>
                        </tr>
                        </thead>
                        <tbody>
                            <th:block th:each="message , i : ${responseDTO.dtoList}">
                              <tr>
                                <th>[[${i.index + responseDTO.start }]]</th>
                                <td name="messageTitle" class="messageTitle" th:data-lid="${message.lid}">[[${message.title}]]</td>
                                <td th:if="${#strings.equals(message.messageStatus, 'UNREAD')}"><span class="badge badge-danger px-2">ì•ˆì½ìŒ</span></td>
                                <td th:if="${#strings.equals(message.messageStatus, 'READ')}"><span class="badge badge-light px-2">ì½ìŒ</span></td>
                                <td> [[${#temporals.format(message.sendDate, 'yyyy/MM/dd')}]]</td>
                                <td class="color-primary">[[${message.sender}]]</td>
                              </tr>

                            </th:block>
                        </tbody>
                      </table>
                      <!--í˜ì´ì§•-->
                      <div class="bootstrap-pagination">
                        <nav>
                          <ul class="pagination justify-content-end">
                            <li class="page-item" th:if="${responseDTO.prev}"><a class="page-link" th:data-num="1"><b><<</b></a>
                            </li>

                            <th:block th:each="i : ${#numbers.sequence(1,responseDTO.lastPage)}">
                              <li th:class="${responseDTO.page == i}?'page-item active':'page-item'">
                                <a class="page-link" th:data-num="${i}">[[${i}]]</a>
                              </li>
                            </th:block>

                            <li class="page-item" th:if="${responseDTO.next}">
                              <a class="page-link" th:data-num="${responseDTO.lastPage}"><b>>></b></a>
                            </li>
                          </ul>
                        </nav>
                      </div>
                      <!--í˜ì´ì§• ë-->
                    </div>
                  </div>

                </div>

                <!-- ë©”ì¸ ì½˜í…íŠ¸ ë -->

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  <div name="writeMessageFormArea">

    <div class="email-right-box" style="margin-left: 0; display: none;" name="writeMessageForm">
      <div class="compose-content mt-5">
        <form action="#">
          <input type="hidden" name="sender" th:value="${#authentication.principal.uid}">
          <div class="form-group">
           <label for="receiver">ë°›ëŠ”ì‚¬ëŒ</label>
            <br/>
            <span>
              <select name="memberSelect" style="width: 10rem;">
                <option value="">------</option>
                <!--ì—¬ê¸°ì— ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ ë“¤ì–´ê°ˆ ê²ƒ-->


              </select>
            </span>
            <br/>
            <br/>
            <input type="text" class="form-control bg-transparent" placeholder=" To" id="receiver" name="receiver" readonly>
          </div>
          <div class="form-group">
            <input type="text" class="form-control bg-transparent" placeholder="ì œëª©" name="title">
          </div>
          <div class="form-group">
            <textarea name="content" class="textarea_editor form-control bg-light" rows="15" placeholder="Enter text ..."></textarea>
          </div>
        </form>

      </div>
      <div class="text-left m-t-15">
        <button class="btn btn-primary m-b-30 m-t-15 f-s-14 p-l-20 p-r-20 m-r-10" type="button" name="sendMessageBtn"><i class="fa fa-paper-plane m-r-5"></i> ë³´ë‚´ê¸° </button>
        <button class="btn btn-dark m-b-30 m-t-15 f-s-14 p-l-20 p-r-20" type="button" name="sendCancleBtn"><i class="ti-close m-r-5 f-s-12"></i> ì·¨ì†Œ </button>
      </div>
    </div>

  </div>
  <!--writeMessageFormAreaë-->

  <!--readMessageArea-->
  <div name="readMessageArea">

    <div class="email-right-box" name="readMessage" style="margin-left: 0; display: none;">
      <div class="toolbar" role="toolbar">

        <div class="btn-group m-b-20">
          <button type="button" class="btn btn-light" name="backBtn"><i class="fa-solid fa-list"></i></button>
          <button type="button" class="btn btn-light" name="deleteBtn"><i class="fa fa-trash"></i></button>
        </div>

      </div>
      <div class="read-content">
        <hr>
        <div class="media mb-4 mt-1">
          <div class="media-body">
            <span class="float-right" name="sendDate" >07:23 AM</span>
            <h4 class="m-0 text-primary" name="messageTitle">ì œëª©</h4>
            <small class="text-muted" name="sender">FROM: ë³´ë‚´ëŠ”ì‚¬ëŒ</small> <br/>
            <small class="text-muted" name="receiver">To: ë°›ëŠ”ì‚¬ëŒ</small>
          </div>
        </div>
        <hr>
        <input name="readMessageLid" type="hidden">
        <!--ì—¬ê¸°ì— ìª½ì§€ ë‚´ìš©-->
        <div name="messageContent">



        </div>
        <hr>
    </div>

    </div>
  </div><!--readMessageArea ë-->
    <!-- #/ container -->

  <script th:inline="javascript">

    var mainList = $("div[name='mainList']"); //ë©”ì¸ ë¦¬ìŠ¤íŠ¸ ì €ì¥
    var type = [[${pageRequestDTO.type}]];

    $(document).ready(function (){

      var pid = [[${pid}]];
      var mid = [[${#authentication.principal.mid}]];
      //ë©¤ë²„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
      $.ajax({
        url:'/project/memberList',
        data:{'pid':pid},
        method:'post',
        success:function (result){
          insertMemberList(result);
        }
      });

      //ì „ì²´ ìª½ì§€ ìˆ˜ ê°€ì ¸ì˜¤ê¸°
      $.ajax({
        url:'/message/count',
        data:{'pid':pid,
          'mid':mid
        },
        type:'post',
        success:function (result){
          $("span[name='countall']").text(result);
        }
      });

      //ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥í•¨ìˆ˜
      function insertMemberList(result){

        var selectList = $("select[name='memberSelect']");
        var str ='';
        for(var member of result){

          str+='<option value="'+member.mid+'">'+member.uid+'</option>';

        }
        selectList.append(str);
      }

      $("select[name='memberSelect']").change(function (){
        //ë°›ëŠ” ë©¤ë²„ ì…€ë ‰íŠ¸ì— ë³€ê²½ì´ ìˆì„ ì‹œ
        $("input[name='receiver']").val($("select[name='memberSelect'] :selected").text());

      });


      $("#sendMessage").on("click",function (e){
        //ìª½ì§€ ì“°ê¸° ë²„íŠ¼ì´ ëˆŒë ¸ì„ ë•Œ
        e.preventDefault();

        var messageForm = $("div[name='writeMessageForm']");
        messageForm.show();
        $("div[name='mainContent']").html(messageForm);
      });

      if(type =='s'){

        $("#sendMessageBox").addClass("text-primary");
        $("#MessageBox").removeClass("text-primary");
        $("#trashMessageBox").removeClass("text-primary");

      }

      if(type =='d'){

        $("#sendMessageBox").removeClass("text-primary");
        $("#MessageBox").removeClass("text-primary");
        $("#trashMessageBox").addClass("text-primary");

      }




    }); //document.ready ë

    $(document).on("click","button[name='sendCancleBtn']",function (e){
      //ìª½ì§€ ì“°ê¸° ì·¨ì†Œë¥¼ ëˆŒë €ì„ ë•Œ
      e.preventDefault();

      var writeMessageForm = $("div[name='writeMessageForm']"); //ìª½ì§€ ì…ë ¥í¼ì„
      $("div[name='writeMessageFormArea']").html(writeMessageForm); // ì›ë˜ ìˆë˜ ì˜ì—­ìœ¼ë¡œ ì˜®ê¹€(ì•ˆë³´ì´ëŠ” ì˜ì—­)
      writeMessageForm.hide(); //ìª½ì§€ ì…ë ¥í¼ ìˆ¨ê¹€
      $("div[name='mainContent']").html(mainList); // ë¯¸ë¦¬ ì €ì¥í•´ë†“ì•˜ë˜ ë¦¬ìŠ¤íŠ¸ë¥¼ ë‹¤ì‹œ mainContent ì˜ì—­ì— ë„£ìŒ


    });

    $(document).on("click","button[name='sendMessageBtn']",function (e){
      //ìª½ì§€ ì „ì†¡ ë²„íŠ¼ì´ ëˆŒë ¸ì„ ë•Œ
      e.preventDefault();

      var title = $("input[name='title']").val();
      var content = $("textarea[name='content']").val();
      var receiver = $("input[name='receiver']").val();
      var sender = [[${#authentication.principal.uid}]];

      $.ajax({
        url:'/message/send',
        type:'post',
        data:{'title':title,
        'content':content,
        'receiver':receiver,
        'sender':sender ,
        'pid':[[${pid}]]},
        success:function (result){
          if(result=='success'){
            alert("ìª½ì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤");
            location.reload();
          }
        }
      }); //ajaxë

    });

    $(document).on("click","td[name='messageTitle']",function (e){
      //ìª½ì§€ ì œëª©ì´ í´ë¦­ëì„ ë•Œ
      var lid = $(this).data("lid");
      var mid = [[${#authentication.principal.mid}]]

      $.ajax({
        url:'/message/read',
        type:'post',
        data:{'lid':lid,
        'mid':mid},
        success:function (result){
          if(result != null){
            readMessageFunc(result);
          }
        }
      });

    });

    function readMessageFunc(result){

      $("span[name='sendDate']").text(result.sendDate);
      $("h4[name='messageTitle']").text(result.title);
      $("small[name='sender']").text("From:  "+result.sender);
      $("small[name='receiver']").text("To:  "+result.receiver);
      $("input[name='readMessageLid']").val(result.lid);
      $("div[name='messageContent']").html(result.content);

      $("div[name='mainContent']").html($("div[name='readMessage']").html());
    }

    $(document).on("click","button[name='backBtn']",function (e){
      //ë’¤ë¡œê°€ê¸° ë²„íŠ¼ì´ ëˆŒë ¸ì„ ë•Œ
      e.preventDefault();
      $("div[name='mainContent']").html(mainList);
    });

    $(document).on("click","button[name='deleteBtn']",function (e){
      //ìª½ì§€ ì‚­ì œ ë²„íŠ¼ì´ ëˆŒë ¸ì„ ë•Œ (íœ´ì§€í†µìœ¼ë¡œ ì´ë™í•¨)
      e.preventDefault();

      if(type=='s'){
        alert("ë³´ë‚¸ ìª½ì§€ëŠ” ì‚­ì œê°€ ë¶ˆê°€í•©ë‹ˆë‹¤!");
        return;
      }else if(type == 'd'){
        alert("ì´ë¯¸ ì‚­ì œëœ ìª½ì§€ì…ë‹ˆë‹¤!");
      }else {

        if(confirm("í•´ë‹¹ ìª½ì§€ë¥¼ ì‚­ì œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){

          var lid = $("input[name='readMessageLid']").val();

          $.ajax({
            url:'/message/delete',
            data:{'lid':lid},
            type:'post',
            success:function (result){
              if(result == 'success'){
                alert("ìª½ì§€ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
              }
            }
          });
        }
      }
    });



  </script>




</th:block>




</html>