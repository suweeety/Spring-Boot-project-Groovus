<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      layout:decorate="~{layout/basic.html}">
<head>
    <meta charset="UTF-8">
    <title>ì—…ë¬´ë¦¬ìŠ¤íŠ¸</title>

    <th:block layout:fragment="css">

        <style>

            #logoImg{
                background-color: #0435d7;
            }

            .modal_{
                position:absolute;
                display:none;
                justify-content: center;
                top:0;
                left:0;
                z-index:99999;
                width:100%;
                height:100%;

                background-color: rgba(0,0,0,0.4);
            }

            .modal_body{
                position:absolute;
                top:5%; /* ëª¨ë‹¬ì„ í™”ë©´ê°€ìš´ë° ë†“ê¸°ìœ„í•¨.  */

                width:50rem;  /* ëª¨ë‹¬ì˜ ê°€ë¡œí¬ê¸°  */
                height:55rem; /* ëª¨ë‹¬ì˜ ì„¸ë¡œí¬ê¸°  */
                padding:40px;

                background-color: rgb(255,255,255);
                border-radius:10px;
                box-shadow:0 2px 3px 0 rgba(34,36,38,0.15);

                transform:translateX(25%);
            }


        </style>

    </th:block>
</head>

<th:block layout:fragment="content">

    <div class="row page-titles mx-0">
        <div class="col p-md-0">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="javascript:void(0)">[[${projectName}]]</a></li>
                <li class="breadcrumb-item active"><a href="javascript:void(0)">Task</a></li>
            </ol>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <div class="email-left-box">

                            <button type="button" class="btn btn-primary btn-block" style="background-color: #0435d7;" name="registerTaskBtn">ì—…ë¬´ë“±ë¡</button>

                            <div class="mail-list mt-4">
                                <a href="#" class="list-group-item border-0 text-primary p-r-0"><span class="fa fa-briefcase f-s-14 mr-2"></span> <b>ì „ì²´ì—…ë¬´</b> <span class="badge badge-primary badge-sm float-right m-t-5" name="wholeTask">0</span> </a>
                                <a href="#" class="list-group-item border-0 p-r-0"><span class="fa fa-tags f-s-14 mr-2"></span>ì°¸ì¡°ì—…ë¬´</a>
                                <a href="#" class="list-group-item border-0 p-r-0"><i class="fa fa-star-o font-18 align-middle mr-2"></i>ì¤‘ìš”ì—…ë¬´ <span class="badge badge-danger badge-sm float-right m-t-5">47</span> </a>
                                <a href="#" class="list-group-item border-0 p-r-0"><i class="fa fa-trash font-18 align-middle mr-2"></i>ì‚­ì œì—…ë¬´</a>
                            </div>
                        </div>
                        <div class="email-right-box">
                            <div role="toolbar" class="toolbar">
                                <div class="btn-group">
                                    <button aria-expanded="false" data-toggle="dropdown" class="btn btn-dark dropdown-toggle" type="button">More <span class="caret m-l-5"></span>
                                    </button>
                                    <div class="dropdown-menu"><span class="dropdown-header">More Option :</span>  <a href="javascript: void(0);" class="dropdown-item">Mark as Unread</a>  <a href="javascript: void(0);" class="dropdown-item">Add to Tasks</a>  <a href="javascript: void(0);" class="dropdown-item">Add Star</a>  <a href="javascript: void(0);" class="dropdown-item">Mute</a>
                                    </div>
                                </div>
                            </div>

                            <!--ì—…ë¬´ë¦¬ìŠ¤íŠ¸ ì‹œì‘-->
                                    <div class="card-body" name="mainContent">
                                        <div name="mainList">
                                        <div class="card-title">
                                            <h4>[[${projectName}]]ì˜ ì—…ë¬´ ëª©ë¡</h4>
                                        </div>
                                        <div class="table-responsive" >
                                            <table class="table">
                                                <thead>
                                                <tr>
                                                    <th>ğŸ’¼</th>
                                                    <th>ì—…ë¬´ì œëª©</th>
                                                    <th>ìƒíƒœ</th>
                                                    <th>ë“±ë¡ì¼</th>
                                                    <th>ë‹´ë‹¹ì</th>
                                                </tr>
                                                </thead>
                                                <tbody>

                                                <th:block th:each="task ,i : ${responseDTO.dtoList}">
                                                        <tr>
                                                            <th>[[${i.index + responseDTO.start }]]</th>
                                                            <td name="readTask" th:data-tid="${task.tid}">[[${task.taskTitle}]]</td>
                                                            <td th:if="${#strings.equals(task.status, 'TODO')}"><span class="badge badge-success px-2">í•  ì¼</span></td>
                                                            <td th:if="${#strings.equals(task.status, 'INPROGRESS')}"><span class="badge badge-primary px-2">ì§„í–‰ì¤‘</span></td>
                                                            <td th:if="${#strings.equals(task.status, 'BLOCK')}"><span class="badge badge-danger px-2">ë³´ë¥˜</span></td>
                                                            <td th:if="${#strings.equals(task.status, 'DONE')}"><span class="badge badge-light px-2">ì™„ë£Œ</span></td>
                                                            <td> [[${#temporals.format(task.regDate, 'yyyy/MM/dd')}]]</td>
                                                            <td class="color-primary">[[${task.responsibleMember}]]</td>
                                                        </tr>

                                                </th:block>
                                                </tbody>
                                            </table>
                                            <!--í˜ì´ì§•-->
                                            <div class="bootstrap-pagination">
                                                <nav>
                                                    <ul class="pagination justify-content-end">
                                                        <li class="page-item" th:if="${responseDTO.prev}"><a class="page-link" th:data-num="1"><b><<</b></a>
                                                        </li>

                                                        <th:block th:each="i : ${#numbers.sequence(1,responseDTO.lastPage)}">
                                                            <li th:class="${responseDTO.page == i}?'page-item active':'page-item'">
                                                                <a class="page-link" th:data-num="${i}">[[${i}]]</a>
                                                            </li>
                                                        </th:block>

                                                        <li class="page-item" th:if="${responseDTO.next}">
                                                            <a class="page-link" th:data-num="${responseDTO.lastPage}"><b>>></b></a>
                                                        </li>
                                                    </ul>
                                                </nav>
                                            </div>
                                            <!--í˜ì´ì§• ë-->
                                        </div>
                                    </div>
                                    </div>
                            <!--ì—…ë¬´ë¦¬ìŠ¤íŠ¸ ë-->

                            <!-- panel -->
                            <div class="row">
                               <!-- <div class="col-7">
                                    <div class="text-left">1 - 20 of 568</div>
                                </div>
                                <div class="col-5">
                                    <div class="btn-group float-right">
                                        <button class="btn btn-gradient" type="button"><i class="fa fa-angle-left"></i>
                                        </button>
                                        <button class="btn btn-dark" type="button"><i class="fa fa-angle-right"></i>
                                        </button>
                                    </div>-->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--ëª¨ë‹¬ì°½-->
    <div class="modal_">
        <div class="modal_body">
            <span  name="modal_close_btn" style="width: 3rem; height: 3rem; font-size: 30px; float:right ; margin-bottom: 1rem; cursor: pointer;"> X </span>
            <br/>

            <form name="taskForm" method="post" action="/task/register">
            <span><b>ì—…ë¬´ ì œëª©</b></span>
            <input type="text" class="form-control input-default" placeholder="ì—…ë¬´ ì œëª© ì…ë ¥ (í•„ìˆ˜)" name="taskTitle" style="display: inline-block; width: 25rem; margin-left: 1rem;">
            <br/>
            <br/>
            <span><b>ì‘ì„±ì</b></span>
            <input type="text" class="form-control input-default" name="taskWriter" th:value="${#authentication.principal.uid}" style="display: inline-block; width: 20rem; margin-left: 2rem;" readonly>
            <br/>
            <br/>
            <span><b>ë‹´ë‹¹ì</b></span>
            <select name="responsibleMember" style="width: 10rem; margin-left: 2rem; height: 2rem;">
                <option value="">------</option>
                <!--ì—¬ê¸°ì— ë©¤ë²„ë“¤ ë³´ì„-->

            </select>
    <!--        <span> <button type="button" class="btn btn-dark mb-2" name="addBtn" style=""> + </button> </span>-->

                <div class="card-body">
                    <span><b>ì²¨ë¶€</b></span>
                    <div class="basic-form">
                            <div class="form-group">
                                <input type="file" class="form-control-file">
                            </div>
                    </div>
                </div>

                <!--ì—ë””í„°-->
                <!--'note-editable panel-body' ì•ˆì— ë“¤ì–´ê°-->
                <div class="card">
                    <div class="card-body">
                        <div class="summernote" style="display: none;" method="post">
                            <h3>ì—…ë¬´ë‚´ìš©ì…ë ¥</h3>
                        </div>
                    </div>
                 </div>
                <!--ì—ë””í„° ë-->

                <input type="hidden" name="taskContent" value="">
                <input type="hidden" name="pid" th:value="${pid}">
                <input type="hidden" name="projectName" th:value="${projectName}">
            </form>
            <button type="button" class="btn mb-1 btn-info" name="registerBtn">ë“±ë¡</button>
         </div>
    </div>
    <!--ëª¨ë‹¬ ë-->

    <div name="taskDetailsArea">

        <!--ì—…ë¬´ ìƒì„¸ë³´ê¸°-->
        <div name="taskDetails" style="display: none">
            <span><button type="button" class="btn mb-1 btn-rounded btn-outline-light" name="readTaskBack">ë’¤ë¡œ</button></span>
            <span><button type="button" class="btn mb-1 btn-rounded btn-outline-success" name="readTaskModify">ìˆ˜ì •</button></span>
            <span><button type="button" class="btn mb-1 btn-rounded btn-outline-danger" name="readTaskDelete">ì‚­ì œ</button></span>

            <!--ìˆ¨ê¹€í•­ëª©-->
            <input type="hidden" name="readTaskTid">

            <br/> <br/>
            <span><b>ì—…ë¬´ ì œëª©</b></span>
            <input type="text" class="form-control input-default" name="readTaskTitle" style="display: inline-block; width: 25rem; margin-left: 1rem;" readonly>
            <br/> <br/>
            <span><b>ìƒíƒœ</b></span>
            <select name="readTaskStatus" style="width: 10rem; margin-left: 3rem; height: 2rem;">
                <option value="TODO" name="status0" style="color: #6fd96f">í• ì¼</option>
                <option value="INPROGRESS"  name="status1" style="color: #4d7cff">ì§„í–‰ì¤‘</option>
                <option value="BLOCK"  name="status2" style="color:#ff5e5e;">ë³´ë¥˜</option>
                <option value="DONE"  name="status3" style="color:#aaa;">ì™„ë£Œ</option>
            </select>

            <span><button type="button" class="btn mb-1 btn-info" name="statusChangeBtn" style="display: none">ë³€ê²½</button></span>

            <br/> <br/>
            <span><b>ì‘ì„±ì</b></span>
            <input type="text" class="form-control input-default" name="readTaskWriter"  style="display: inline-block; width: 20rem; margin-left: 2rem;" readonly>
            <br/> <br/>
            <span><b>ë‹´ë‹¹ì</b></span>
            <input type="text" class="form-control input-default" name="readResponsibleMember"  style="display: inline-block; width: 20rem; margin-left: 2rem;" readonly>
            <br/> <br/>
            <span><b>ì‘ì„±ì¼</b></span>
            <input type="text" class="form-control input-default" name="readTaskRegDate" style="display: inline-block; width: 25rem; margin-left: 2rem;" readonly>
            <br/> <br/> <br/>  <br/>
            <div name="readTaskContent" class="form-control input-default" style="height:auto;">

            </div>

            <button type="button" class="btn mb-1 btn-outline-primary btn-xs" name="showHistoryBtn">ìƒíƒœ ë³€ê²½ ì´ë ¥ ë³´ê¸°</button>
            <button type="button" class="btn mb-1 btn-outline-primary btn-xs" name="closeHistoryBtn" style="display: none;">ìƒíƒœ ë³€ê²½ ì´ë ¥ ë‹«ê¸°</button>
            <!--ìƒíƒœë³€ê²½ íˆìŠ¤í† ë¦¬-->
            <div name="history" style="display: none">
                <div class="card-body">
                    <div class="card-title">
                        <h4>ìƒíƒœë³€ê²½ ì´ë ¥</h4>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th>ë³€ê²½ì¼</th>
                                <th>ë³€ê²½ì „</th>
                                <th>ë³€ê²½í›„</th>
                                <th>ë³€ê²½ì</th>
                            </tr>
                            </thead>
                            <tbody th:name="historyBody">



                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <!--ìƒíƒœë³€ê²½ íˆìŠ¤í† ë¦¬ ë-->
        </div>
        <!--ì—…ë¬´ ìƒì„¸ë³´ê¸°ì°½ ë-->


    </div>


    <!--ìŠ¤í¬ë¦½íŠ¸-->
    <script th:inline="javascript">

        var pid = [[${pid}]];
        var PrevStatus; // ìƒíƒœ ë³€ê²½ì‹œ ì €ì¥ë  ì„ì‹œ ê³µê°„

        $(document).ready(function (){

            var mainList = $("div[name='mainList']");

            $(document).keydown(function(event){
                if(event.keyCode == 116) { // F5 í‚¤ ëˆŒë ¸ì„ ë•Œ
                    event.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€
                    var newUrl = "/project/task/"+[[${pid}]]+"/"+[[${projectName}]];
                    location.href = newUrl;
                }
            });

            /* ajaxë¡œ í”„ë¡œì íŠ¸ì— ì†í•œ ë©¤ë²„ë“¤ ì •ë³´ë¥¼ ì–»ì–´ì˜´ */
            $.ajax({
                url:'/project/memberList',
                data:{'pid':pid},
                method:'post',
                success:function (result){
                    insertMemberList(result);
                }
            });

            /* ajaxë¡œ í”„ë¡œì íŠ¸ì˜ ì „ì²´ ì—…ë¬´ ê°œìˆ˜ë¥¼ ì–»ì–´ì˜´*/
            $.ajax({
                url:'/task/countall',
                type:'post',
                data:{'pid':pid},
                success:function (result){
                    $("span[name='wholeTask']").text(result);
                }
            })

            //ì—…ë¬´ ë“±ë¡í•˜ê¸° ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ
            $("button[name='registerTaskBtn']").on("click",function (e){
               e.preventDefault();
                $(".modal_").show();
            });

            //ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ
            $(document).on("click","span[name='modal_close_btn']",function(){
                $(".modal_").hide();
            });

            //ë©¤ë²„ ë¦¬ìŠ¤íŠ¸ ì¶œë ¥
            function insertMemberList(result){

                var selectList = $("select[name='responsibleMember']");
                var str ='';
                for(var member of result){

                    str+='<option value="'+member.mid+'">'+member.uid+'</option>';

                }
                selectList.append(str);
            }

            //ì—…ë¬´ì½ê¸°ì—ì„œ ë’¤ë¡œê°€ê¸° ë²„íŠ¼ì´ ëˆŒë ¸ì„ ë•Œ
            $(document).on("click","button[name='readTaskBack']",function (e){
                e.preventDefault();

                $("button[name='showHistoryBtn']").show();
                $("button[name='closeHistoryBtn']").hide();
                $("button[name='statusChangeBtn']").hide();
                $("div[name='taskDetailsArea']").html( $("div[name='taskDetails']")); //ì—…ë¬´ ìƒì„¸ë³´ê¸°ì°½ ì´ë™

                $("div[name='taskDetails']").hide(); //ìˆ¨ê¹€
                $("div[name='history']").hide(); //ìˆ¨ê¹€

                $("div[name='mainContent']").html(mainList); //ë©”ì¸ì½˜í…ì¸ ê³µê°„ì— ë©”ì¸ë¦¬ìŠ¤íŠ¸ ì´ë™
            });

            //ì—…ë¬´ ì œëª©ì„ ëˆŒë €ì„ë•Œ (ì—…ë¬´ë‚´ìš© ë³´ì¼ì˜ˆì •)
            $(document).on("click","td[name='readTask']",function (e){

                e.preventDefault();
                var tid = $(this).data("tid");

                $.ajax({
                    url:'/task/view',
                    type:'post',
                    data:{'tid':tid},
                    success:function (result){
                        console.log(result);
                        readTask(result);
                    }
                });
            });

            //ì—…ë¬´ ì½ê¸°
            function readTask(result){

                var taskDetails = $("div[name='taskDetails']"); //ì—…ë¬´ ìƒì„¸ë³´ê¸° ì°½

                var selectStatus = $("select[name='readTaskStatus']");

                $("input[name='readTaskTid']").val(result.tid);
                $("input[name='readTaskTitle']").val(result.taskTitle);
                $("input[name='readTaskWriter']").val(result.taskWriter);
                $("input[name='readResponsibleMember']").val(result.responsibleMember);
                $("input[name='readTaskRegDate']").val(result.regDate);
                selectStatus.val(result.status);
                $("div[name='readTaskContent']").html(result.taskContent);

                PrevStatus = $("select[name='readTaskStatus']").val(); //ìƒíƒœ ì„ì‹œ ì €ì¥

                taskDetails.show();

                $("div[name='mainContent']").html(taskDetails); //ë©”ì¸ ì½˜í…ì¸ ìª½ì— ë„£ìŒ
            }

        });

        //ì—…ë¬´ ìƒì„¸ë³´ê¸° -> ìƒíƒœë³€ê²½ ì…€ë ‰íŠ¸ ë°•ìŠ¤ì— ë³€ê²½ì´ ê°ì§€ë˜ë©´
       $("select[name='readTaskStatus']").change(function (){

           //ë³€ê²½ ë²„íŠ¼ ë…¸ì¶œ
           $("button[name='statusChangeBtn']").show();
       })

        //ì—…ë¬´ì˜ ìƒì„¸ë³´ê¸° -> ìƒíƒœ ë³€ê²½ ë²„íŠ¼ì´ ëˆŒë ¸ì„ ë•Œ
        $("button[name='statusChangeBtn']").on("click",function (e){
            e.preventDefault();

            var tid = $("input[name='readTaskTid']").val()+"";
            var status = $("select[name='readTaskStatus']").val();
            var uid = [[${#authentication.principal.uid}]];
            var prevStatus = PrevStatus;
            //í•´ë‹¹ ì—…ë¬´ì˜ ìƒíƒœë¥¼ ë³€ê²½
            $.ajax({
               url:'/task/changestatus',
               data:{'tid':tid,
                     'status':status,
                      'uid' : uid,
                      'prevStatus':prevStatus
               },
               type:'post',
               success:function(result){

                   location.reload();
               }
            });
        });

       //ìƒíƒœ ë³€ê²½ì´ë ¥ë³´ê¸° ë²„íŠ¼ì´ ëˆŒë ¸ë‹¤ë©´
       $(document).on("click","button[name='showHistoryBtn']",function (e){
           e.preventDefault();
           $(this).hide();
           $("button[name='closeHistoryBtn']").show();

           var tid =  $("input[name='readTaskTid']").val();

           $.ajax({
              url:'/task/history',
              type:'post',
              data:{'tid':tid},
              success:function (result){
                  console.log(result);
                  showHistory(result);
              }
           });
       });

       $(document).on("click","button[name='closeHistoryBtn']",function (e){
           //ìƒíƒœ ì´ë ¥ ë³´ê¸° ë‹«ê¸°ë²„íŠ¼ì´ ëˆŒë ¸ë‹¤ë©´
           e.preventDefault();
           $(this).hide();
           $("button[name='showHistoryBtn']").show();

           $("div[name='history']").hide();
       });

       function showHistory(result){
            var str ='';

            if(result==null){

                str = "<b>ìƒíƒœ ë³€ê²½ ì´ë ¥ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</b>";

            }else {

                for(var i=0;i<result.length;i++){

                    var prevStatus;
                    var status;

                    if(result[i].status=='TODO'){
                        status='í• ì¼';
                    }else if(result[i].status=='INPROGRESS'){
                        status='ì§„í–‰ì¤‘';
                    }else if(result[i].status=='BLOCK'){
                        status='ë³´ë¥˜';
                    }else if(result[i].status=='DONE'){
                        status='ì™„ë£Œ';
                    }

                    if(result[i].prevStatus=='TODO'){
                        prevStatus='í• ì¼';
                    }else if(result[i].prevStatus=='INPROGRESS'){
                        prevStatus='ì§„í–‰ì¤‘';
                    }else if(result[i].prevStatus=='BLOCK'){
                        prevStatus='ë³´ë¥˜';
                    }else if(result[i].prevStatus=='DONE'){
                        prevStatus='ì™„ë£Œ';
                    }

                    str += "<tr><th>"+result[i].modDate+"</th><td>"+prevStatus+"</td>"
                        +"<td>"+status+"</span></td>"
                        +"<td>"+result[i].uid+"</td></tr>";
                }
            }
            $("tbody[name='historyBody']").html(str);
            $("div[name='history']").show();
       };

        $(document).on("click","button[name='registerBtn']",function (e){
            //ì—…ë¬´ ë“±ë¡ ë²„íŠ¼ ëˆŒë €ì„ë•Œ
            e.preventDefault();

            var taskForm = $("form[name='taskForm']");
            var htmlStr = $("div.note-editable").html();

            $("input[name='taskContent']").val(htmlStr);

            taskForm.submit();

        })

        //í˜ì´ì§• ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ
        $("a.page-link").on("click", function (event) {

            event.preventDefault(); // ë§í¬ì˜ ê¸°ë³¸ ë™ì‘ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.

            var pageNum = $(this).data("num");
            var mid = [[${mid}]];
            var type = [[${pageRequestDTO.type}]];
            var keyword = [[${pageRequestDTO.keyword}]];

            if(type != null && keyword!=null){
                var url = '/task/list/'+[[${pid}]]+'/'+[[${projectName}]]+'?page='+pageNum+'&type='+type+'&keyword='+keyword;
            }else{
                var url = '/task/list/'+[[${pid}]]+'/'+[[${projectName}]]+'?page='+pageNum;
            }
            window.location.href = url; // ìƒˆë¡œìš´ URLë¡œ ì´ë™í•©ë‹ˆë‹¤.
        });

    </script>

</th:block>

</html>

















