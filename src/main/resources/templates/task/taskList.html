<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6"
      layout:decorate="~{layout/basic.html}">
<head>
    <meta charset="UTF-8">
    <title>ÏóÖÎ¨¥Î¶¨Ïä§Ìä∏</title>

    <th:block layout:fragment="css">

        <style>

            #logoImg{
                background-color: #0435d7;
            }

            .modal_{
                position:absolute;
                display:none;
                justify-content: center;
                top:0;
                left:0;
                z-index:99999;
                width:100%;
                height:100%;

                background-color: rgba(0,0,0,0.4);
            }

            .modal_body{
                position:absolute;
                top:5%; /* Î™®Îã¨ÏùÑ ÌôîÎ©¥Í∞ÄÏö¥Îç∞ ÎÜìÍ∏∞ÏúÑÌï®.  */

                width:50rem;  /* Î™®Îã¨Ïùò Í∞ÄÎ°úÌÅ¨Í∏∞  */
                height:55rem; /* Î™®Îã¨Ïùò ÏÑ∏Î°úÌÅ¨Í∏∞  */
                padding:40px;

                background-color: rgb(255,255,255);
                border-radius:10px;
                box-shadow:0 2px 3px 0 rgba(34,36,38,0.15);

                transform:translateX(25%);
            }

            .taskTitle:hover{
                color: #0d4dff;
                cursor: pointer;
            }

            .popup {
                position: absolute;
                background-color: #fff;
                border: 1px solid #ccc;
                padding: 10px;
                display: none;
            }

        </style>

    </th:block>
</head>

<th:block layout:fragment="content">

    <div class="row page-titles mx-0">
        <div class="col p-md-0">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="javascript:void(0)">[[${projectName}]]</a></li>
                <li class="breadcrumb-item active"><a href="javascript:void(0)">Task</a></li>
            </ol>
        </div>
    </div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-body">
                        <div class="email-left-box">

                            <button type="button" class="btn btn-primary btn-block" style="background-color: #0435d7;" name="registerTaskBtn">ÏóÖÎ¨¥Îì±Î°ù</button>

                            <div class="mail-list mt-4">
                                <a th:href="@{'/project/task/' + ${pid}+'/'+${projectName}}" class="list-group-item border-0 text-primary p-r-0" id="wholeTask"><span class="fa fa-briefcase f-s-14 mr-2" ></span> <b>Ï†ÑÏ≤¥ÏóÖÎ¨¥</b> <span class="badge badge-primary badge-sm float-right m-t-5" name="wholeTask">0</span> </a>
                                <a th:href="@{'/project/task/' + ${pid}+'/'+${projectName}+'?type=r&keyword='+${#authentication.principal.mid}}" class="list-group-item border-0 p-r-0" id="myTask"><span class="fa fa-tags f-s-14 mr-2"></span><b>Îã¥ÎãπÏóÖÎ¨¥</b><span class="badge badge-primary badge-sm float-right m-t-5" name="myTask">0</span></a>
                                <a th:href="@{'/project/task/' + ${pid}+'/'+${projectName}+'?type=d&keyword='+${#authentication.principal.uid}}" class="list-group-item border-0 p-r-0" id="delTask"><i class="fa fa-trash font-18 align-middle mr-2"></i><b>ÏÇ≠Ï†úÏóÖÎ¨¥</b><span class="badge badge-primary badge-sm float-right m-t-5" name="delTask">0</span></a>
                            </div>
                        </div>
                        <div class="email-right-box">
                            <div role="toolbar" class="toolbar">
                                <div class="btn-group">
                                    <button aria-expanded="false" data-toggle="dropdown" class="btn btn-dark dropdown-toggle" type="button">More <span class="caret m-l-5"></span>
                                    </button>
                                    <div class="dropdown-menu"><span class="dropdown-header">More Option :</span> <a href="javascript: void(0);" class="dropdown-item">Ï§ÄÎπÑÏ§ë</a>  <a href="javascript: void(0);" class="dropdown-item">Ï§ÄÎπÑÏ§ë </a>  <a href="javascript: void(0);" class="dropdown-item">Ï§ÄÎπÑÏ§ë</a>  <a href="javascript: void(0);" class="dropdown-item">Ï§ÄÎπÑÏ§ë</a>
                                    </div>
                                </div>
                            </div>

                            <!--ÏóÖÎ¨¥Î¶¨Ïä§Ìä∏ ÏãúÏûë-->
                            <div class="card-body" name="mainContent">


                                <div name="mainList">
                                    <div class="card-title">
                                        <h4>[[${projectName}]]Ïùò ÏóÖÎ¨¥ Î™©Î°ù</h4>
                                    </div>
                                    <div class="table-responsive" >
                                        <table class="table">
                                            <thead>
                                            <tr>
                                                <th>üíº</th>
                                                <th>ÏóÖÎ¨¥Ï†úÎ™©</th>
                                                <th>ÏÉÅÌÉú</th>
                                                <th>Îì±Î°ùÏùº</th>
                                                <th>Îã¥ÎãπÏûê</th>
                                            </tr>
                                            </thead>
                                            <tbody>

                                            <th:block th:each="task ,i : ${responseDTO.dtoList}">
                                                <tr>
                                                    <th>[[${i.index + responseDTO.start }]]</th>
                                                    <td name="readTask" class="taskTitle" th:data-tid="${task.tid}">[[${task.taskTitle}]]</td>
                                                    <td th:if="${#strings.equals(task.status, 'TODO')}"><span class="badge badge-success px-2">Ìï† Ïùº</span></td>
                                                    <td th:if="${#strings.equals(task.status, 'INPROGRESS')}"><span class="badge badge-primary px-2">ÏßÑÌñâÏ§ë</span></td>
                                                    <td th:if="${#strings.equals(task.status, 'BLOCK')}"><span class="badge badge-danger px-2">Î≥¥Î•ò</span></td>
                                                    <td th:if="${#strings.equals(task.status, 'DONE')}"><span class="badge badge-light px-2">ÏôÑÎ£å</span></td>
                                                    <td> [[${#temporals.format(task.regDate, 'yyyy/MM/dd')}]]</td>
                                                    <td class="color-primary">[[${task.responsibleMember}]]</td>
                                                </tr>

                                            </th:block>
                                            </tbody>
                                        </table>
                                        <!--ÌéòÏù¥Ïßï-->
                                        <div class="bootstrap-pagination">
                                            <nav>
                                                <ul class="pagination justify-content-end">
                                                    <li class="page-item" th:if="${responseDTO.prev}"><a class="page-link" th:data-num="1"><b><<</b></a>
                                                    </li>

                                                    <th:block th:each="i : ${#numbers.sequence(1,responseDTO.lastPage)}">
                                                        <li th:class="${responseDTO.page == i}?'page-item active':'page-item'">
                                                            <a class="page-link" th:data-num="${i}">[[${i}]]</a>
                                                        </li>
                                                    </th:block>

                                                    <li class="page-item" th:if="${responseDTO.next}">
                                                        <a class="page-link" th:data-num="${responseDTO.lastPage}"><b>>></b></a>
                                                    </li>
                                                </ul>
                                            </nav>
                                        </div>
                                        <!--ÌéòÏù¥Ïßï ÎÅù-->
                                    </div>
                                </div>
                            </div>
                            <!--ÏóÖÎ¨¥Î¶¨Ïä§Ìä∏ ÎÅù-->

                            <!-- panel -->
                            <div class="row">
                                <!-- <div class="col-7">
                                     <div class="text-left">1 - 20 of 568</div>
                                 </div>
                                 <div class="col-5">
                                     <div class="btn-group float-right">
                                         <button class="btn btn-gradient" type="button"><i class="fa fa-angle-left"></i>
                                         </button>
                                         <button class="btn btn-dark" type="button"><i class="fa fa-angle-right"></i>
                                         </button>
                                     </div>-->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!--Î™®Îã¨Ï∞Ω-->
    <div class="modal_">
        <div class="modal_body">
            <span  name="modal_close_btn" style="width: 3rem; height: 3rem; font-size: 30px; float:right ; margin-bottom: 1rem; cursor: pointer;"> X </span>
            <br/>

            <form name="taskForm" method="post" action="/task/register">
                <span><b>ÏóÖÎ¨¥ Ï†úÎ™©</b></span>
                <input type="text" class="form-control input-default" placeholder="ÏóÖÎ¨¥ Ï†úÎ™© ÏûÖÎ†• (ÌïÑÏàò)" name="taskTitle" style="display: inline-block; width: 25rem; margin-left: 1rem;">
                <br/>
                <br/>
                <span><b>ÏûëÏÑ±Ïûê</b></span>
                <input type="text" class="form-control input-default" name="taskWriter" th:value="${#authentication.principal.uid}" style="display: inline-block; width: 20rem; margin-left: 2rem;" readonly>
                <br/>
                <br/>
                <span><b>Îã¥ÎãπÏûê</b></span>
                <select name="responsibleMember" style="width: 10rem; margin-left: 2rem; height: 2rem;">
                    <option value="">------</option>
                    <!--Ïó¨Í∏∞Ïóê Î©§Î≤ÑÎì§ Î≥¥ÏûÑ-->

                </select>
                <!--        <span> <button type="button" class="btn btn-dark mb-2" name="addBtn" style=""> + </button> </span>-->

                <!--                <div class="card-body">
                                    <span><b>Ï≤®Î∂Ä</b></span>
                                    <div class="basic-form">
                                            <div class="form-group">
                                                <input type="file" class="form-control-file"  multiple>
                                                <div name="fileList"></div>
                                            </div>
                                    </div>
                                </div>-->

                <!--ÏóêÎîîÌÑ∞-->
                <!--'note-editable panel-body' ÏïàÏóê Îì§Ïñ¥Í∞ê-->
                <div class="card">
                    <div class="card-body">
                        <div class="summernote" style="display: none;" method="post">
                            <h3>ÏóÖÎ¨¥ÎÇ¥Ïö©ÏûÖÎ†•</h3>
                        </div>
                    </div>
                </div>
                <!--ÏóêÎîîÌÑ∞ ÎÅù-->

                <input type="hidden" name="taskContent" value="">
                <input type="hidden" name="pid" th:value="${pid}">
                <input type="hidden" name="projectName" th:value="${projectName}">
            </form>
            <button type="button" class="btn mb-1 btn-info" name="registerBtn">Îì±Î°ù</button>
        </div>
    </div>
    <!--Î™®Îã¨ ÎÅù-->

    <div name="taskDetailsArea">

        <!--ÏóÖÎ¨¥ ÏÉÅÏÑ∏Î≥¥Í∏∞-->
        <div name="taskDetails" style="display: none" >

            <span><button type="button" class="btn mb-1 btn-rounded btn-outline-light" name="readTaskBack">Îí§Î°ú</button></span>
            <span><button type="button" class="btn mb-1 btn-rounded btn-outline-success" name="readTaskModify">ÏàòÏ†ï</button></span>
            <span><button type="button" class="btn mb-1 btn-rounded btn-outline-danger" name="readTaskDelete">ÏÇ≠Ï†ú</button></span>

            <!--Ïà®ÍπÄÌï≠Î™©-->
            <input type="hidden" name="readTaskTid">

            <br/> <br/>
            <span><b>ÏóÖÎ¨¥ Ï†úÎ™©</b></span>
            <input type="text" class="form-control input-default" name="readTaskTitle" style="display: inline-block; width: 25rem; margin-left: 1rem;" readonly>
            <br/> <br/>
            <span><b>ÏÉÅÌÉú</b></span>
            <select name="readTaskStatus" style="width: 10rem; margin-left: 3rem; height: 2rem;">
                <option value="TODO" name="status0" style="color: #6fd96f">Ìï†Ïùº</option>
                <option value="INPROGRESS"  name="status1" style="color: #4d7cff">ÏßÑÌñâÏ§ë</option>
                <option value="BLOCK"  name="status2" style="color:#ff5e5e;">Î≥¥Î•ò</option>
                <option value="DONE"  name="status3" style="color:#aaa;">ÏôÑÎ£å</option>
            </select>

            <span><button type="button" class="btn mb-1 btn-info" name="statusChangeBtn" style="display: none">Î≥ÄÍ≤Ω</button></span>

            <br/> <br/>
            <span><b>ÏûëÏÑ±Ïûê</b></span>
            <input type="text" class="form-control input-default" name="readTaskWriter"  style="display: inline-block; width: 20rem; margin-left: 2rem;" readonly>
            <br/> <br/>
            <span><b>Îã¥ÎãπÏûê</b></span>
            <select name="modifyresponsibleMember" style="width: 10rem; margin-left: 2rem; height: 2rem; display: none;" >
                <option value="">------</option>
                <!--Ïó¨Í∏∞Ïóê Î©§Î≤ÑÎì§ Î≥¥ÏûÑ-->

            </select>
            <input type="text" class="form-control input-default" name="readResponsibleMember"  style="display: inline-block; width: 20rem; margin-left: 2rem;" readonly>
            <br/> <br/>
            <span><b>ÏûëÏÑ±Ïùº</b></span>
            <input type="text" class="form-control input-default" name="readTaskRegDate" style="display: inline-block; width: 25rem; margin-left: 2rem;" readonly>
            <br/> <br/> <br/>  <br/>
            <!--ÏóÖÎ¨¥ ÎÇ¥Ïö©-->
            <div name="readTaskContent" class="form-control input-default" style="height:auto; margin-bottom: 1rem;">

            </div>

            <!--ÏóêÎîîÌÑ∞-->
            <!--'note-editable panel-body' ÏïàÏóê Îì§Ïñ¥Í∞ê-->
            <div class="card" name="modifyContent" style="display: none;">
                <div class="card-body">
                    <div class="summernote" style="display: none;" method="post">
                        <h3>ÏóÖÎ¨¥ÎÇ¥Ïö©ÏûÖÎ†•</h3>
                    </div>
                </div>
            </div>
            <!--ÏóêÎîîÌÑ∞ ÎÅù-->

            <button type="button" class="btn mb-1 btn-outline-primary btn-xs" name="showHistoryBtn">ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïù¥Î†• Î≥¥Í∏∞</button>
            <button type="button" class="btn mb-1 btn-outline-primary btn-xs" name="closeHistoryBtn" style="display: none;">ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïù¥Î†• Îã´Í∏∞</button>
            <!--ÏÉÅÌÉúÎ≥ÄÍ≤Ω ÌûàÏä§ÌÜ†Î¶¨-->
            <div name="history" style="display: none">
                <div class="card-body">
                    <div class="card-title">
                        <h4>ÏÉÅÌÉúÎ≥ÄÍ≤Ω Ïù¥Î†•</h4>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                            <tr>
                                <th>Î≥ÄÍ≤ΩÏùº</th>
                                <th>Î≥ÄÍ≤ΩÏ†Ñ</th>
                                <th>Î≥ÄÍ≤ΩÌõÑ</th>
                                <th>Î≥ÄÍ≤ΩÏûê</th>
                            </tr>
                            </thead>

                            <tbody th:name="historyBody">
                            <!--ÏÉÅÌÉú Î≥ÄÍ≤ΩÏù¥Î†•-->
                            </tbody>

                        </table>
                    </div>
                </div>
            </div>
            <!--ÏÉÅÌÉúÎ≥ÄÍ≤Ω ÌûàÏä§ÌÜ†Î¶¨ ÎÅù-->
            <!--ÎåìÍ∏Ä Î¶¨Ïä§Ìä∏-->
            <div name="replyList">



            </div>
            <!--ÎåìÍ∏Ä Î¶¨Ïä§Ìä∏ ÎÅù-->
            <!--ÎåìÍ∏Ä Ïì∞Îäî Î∂ÄÎ∂Ñ ÏãúÏûë-->
            <div class="card">
                <div class="card-body">
                    <form action="#" class="form-profile" name="replyForm">
                        <div class="form-group" style="position: relative">
                            <div class="popup">This is a popup div.</div>
                            <textarea class="form-control" name="replyText" id="textarea" cols="30" rows="2" placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>
                        </div>
                        <div class="d-flex align-items-center">
                            <ul class="mb-0 form-profile__icons">
                                <li class="d-inline-block">
                                    <button class="btn btn-transparent p-0 mr-3"><i class="fa fa-user"></i></button>
                                </li>
                                <li class="d-inline-block">
                                    <button class="btn btn-transparent p-0 mr-3"><i class="fa fa-paper-plane"></i></button>
                                </li>
                                <li class="d-inline-block">
                                    <button class="btn btn-transparent p-0 mr-3"><i class="fa fa-camera"></i></button>
                                </li>
                                <li class="d-inline-block">
                                    <button class="btn btn-transparent p-0 mr-3"><i class="fa fa-smile"></i></button>
                                </li>
                            </ul>

                            <input type="hidden" name="readTaskTid">
                            <input type="hidden" name="uid" th:value="${#authentication.principal.uid}">
                            <button class="btn btn-primary px-3 ml-4" name="regusterReplyBtn">Îì±Î°ù</button>
                        </div>
                    </form>
                </div>
            </div>
            <!--ÎåìÍ∏Ä ÎÅù-->
        </div>
        <!--ÏóÖÎ¨¥ ÏÉÅÏÑ∏Î≥¥Í∏∞Ï∞Ω ÎÅù-->
    </div>



    <!--Ïä§ÌÅ¨Î¶ΩÌä∏-->
    <script th:inline="javascript">

        var pid = [[${pid}]];
        var PrevStatus; // ÏÉÅÌÉú Î≥ÄÍ≤ΩÏãú Ï†ÄÏû•Îê† ÏûÑÏãú Í≥µÍ∞Ñ

        $(document).ready(function (){

            var mainList = $("div[name='mainList']");

            var type = [[${pageRequestDTO.type}]]; //projectPageRequestDTO


            /* ajaxÎ°ú ÌîÑÎ°úÏ†ùÌä∏Ïùò Ï†ÑÏ≤¥ ÏóÖÎ¨¥ Í∞úÏàòÎ•º ÏñªÏñ¥Ïò¥*/
            $.ajax({
                url:'/task/countall',
                type:'post',
                data:{'pid':pid ,
                    'mid':[[${#authentication.principal.mid}]],
                    'uid':[[${#authentication.principal.uid}]]
                },
                success:function (result){

                    $("span[name='wholeTask']").text(result[0]);
                    $("span[name='myTask']").text(result[1]);
                    $("span[name='delTask']").text(result[2]);
                }
            });
            /* ajaxÎ°ú ÌîÑÎ°úÏ†ùÌä∏Ïóê ÏÜçÌïú Î©§Î≤ÑÎì§ Ï†ïÎ≥¥Î•º ÏñªÏñ¥Ïò¥ */
            $.ajax({
                url:'/project/memberList',
                data:{'pid':pid},
                method:'post',
                success:function (result){
                    insertMemberList(result);
                }
            });

            $(document).keydown(function(event){
                if(event.keyCode == 116) { // F5 ÌÇ§ ÎàåÎ†∏ÏùÑ Îïå
                    event.preventDefault(); // Í∏∞Î≥∏ ÎèôÏûë Î∞©ÏßÄ
                    var newUrl = "/project/task/"+[[${pid}]]+"/"+[[${projectName}]];
                    location.href = newUrl;

                }
            });

            /*----------------------------------------*/
            /*Î©òÏÖòÍ∏∞Îä• (Íµ¨ÌòÑÏ§ë)*/

            var popup = $(".popup");
            var textarea =  $("textarea[name='replyText']");
            var re_replyText = $("textarea[name='re-replyText']");

            // textareaÏóêÏÑú @ ÏûÖÎ†• Ïãú ÌåùÏóÖ ÌëúÏãú
            textarea.on("input", function(event) {

                var text = textarea.val();
                var atIndex = text.lastIndexOf("@");
                if (atIndex !== -1) {
                    var linesBeforeAt = text.substring(0, atIndex).split("\n");
                    var lineNumber = linesBeforeAt.length;
                    var lineHeight = parseInt(textarea.css("line-height"));
                    var scrollTop = textarea.scrollTop();

                    // @Ïùò ÏúÑÏπòÏóê Îî∞Î•∏ Y Ï¢åÌëú Í≥ÑÏÇ∞
                    var posY = lineNumber * lineHeight - scrollTop;
                    var posX = 0; // ÏôºÏ™ΩÏóê ÌëúÏãú

                    /* ajaxÎ°ú ÌîÑÎ°úÏ†ùÌä∏Ïóê ÏÜçÌïú Î©§Î≤ÑÎì§ Ï†ïÎ≥¥Î•º ÏñªÏñ¥Ïò¥ */
                    $.ajax({
                        url:'/project/memberList',
                        data:{'pid':pid},
                        method:'post',
                        success:function (result){
                            var str ='<ul>';
                            if(result!=null){
                                for(var member of result){
                                    str+= '<li name="mentionTag" data-mid="'+member.mid+'">'+member.uid+'</li>';
                                }
                            }
                            str+='</ul>';
                            popup.html(str);
                        }
                    }); //ajax ÎÅù

                    popup.css({top: posY, left: posX}).show();
                } else {
                    popup.hide();
                }
            });

            $(document).on("input","textarea[name='re-replyText']",function (event){
                var text = $("textarea[name='re-replyText']").val();
                var mentiopnPop = $(this).prev(".popup");

                var atIndex = text.lastIndexOf("@");
                if (atIndex !== -1) {
                    var linesBeforeAt = text.substring(0, atIndex).split("\n");
                    var lineNumber = linesBeforeAt.length;
                    var lineHeight = parseInt(textarea.css("line-height"));
                    var scrollTop = textarea.scrollTop();

                    // @Ïùò ÏúÑÏπòÏóê Îî∞Î•∏ Y Ï¢åÌëú Í≥ÑÏÇ∞
                    var posY = lineNumber * lineHeight - scrollTop;
                    var posX = 0; // ÏôºÏ™ΩÏóê ÌëúÏãú

                    /* ajaxÎ°ú ÌîÑÎ°úÏ†ùÌä∏Ïóê ÏÜçÌïú Î©§Î≤ÑÎì§ Ï†ïÎ≥¥Î•º ÏñªÏñ¥Ïò¥ */
                    $.ajax({
                        url:'/project/memberList',
                        data:{'pid':pid},
                        method:'post',
                        success:function (result){
                            var str ='<ul>';
                            if(result!=null){
                                for(var member of result){
                                    str+= '<li name="mentionTag" data-mid="'+member.mid+'">'+member.uid+'</li>';
                                }
                            }
                            str+='</ul>';
                            mentiopnPop.html(str);
                            mentiopnPop.css({top: posY, left: posX}).show();
                        }
                    }); //ajax ÎÅù

                } else {
                    mentiopnPop.hide();
                }
            });

            // Îã§Î•∏ Í≥≥ ÌÅ¥Î¶≠ Ïãú div Ïà®Í∏∞Í∏∞
            $(document).on("click", function(event){
                if (!$(event.target).closest(".popup").length) {
                    $(".popup").hide();
                }
            });
            /*----------------------------------------*/
            if(type =='r'){
                //Îã¥ÎãπÏóÖÎ¨¥ÌÉ≠
                $("#myTask").addClass("text-primary");
                $("#wholeTask").removeClass("text-primary");
                $("#delTask").removeClass("text-primary");
            };

            if(type =='d'){
                //ÏÇ≠Ï†úÏóÖÎ¨¥ÌÉ≠
                $("#myTask").removeClass("text-primary");
                $("#wholeTask").removeClass("text-primary");
                $("#delTask").addClass("text-primary");
            }

            //ÏóÖÎ¨¥ Îì±Î°ùÌïòÍ∏∞ Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏùÑ Îïå
            $("button[name='registerTaskBtn']").on("click",function (e){
                e.preventDefault();
                $(".modal_").show();
            });

            //Î™®Îã¨ Îã´Í∏∞ Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏùÑ Îïå
            $(document).on("click","span[name='modal_close_btn']",function(){
                $(".modal_").hide();
            });

            //Î©§Î≤Ñ Î¶¨Ïä§Ìä∏ Ï∂úÎ†•Ìï®Ïàò
            function insertMemberList(result){

                var selectList = $("select[name='responsibleMember']");
                var modifyselectList = $("select[name='modifyresponsibleMember']");
                var str ='';
                for(var member of result){

                    str+='<option value="'+member.mid+'">'+member.uid+'</option>';

                }
                selectList.append(str);
                modifyselectList.append(str);
            }

            //ÏóÖÎ¨¥ÏùΩÍ∏∞ÏóêÏÑú Îí§Î°úÍ∞ÄÍ∏∞ Î≤ÑÌäºÏù¥ ÎàåÎ†∏ÏùÑ Îïå
            $(document).on("click","button[name='readTaskBack']",function (e){
                e.preventDefault();
                $("button[name='showHistoryBtn']").show(); //ÌûàÏä§ÌÜ†Î¶¨Î≥¥Í∏∞ Î≤ÑÌäº Î≥¥Ïù¥Í≤å
                $("button[name='closeHistoryBtn']").hide(); //ÌûàÏä§ÌÜ†Î¶¨Îã´Í∏∞ Î≤ÑÌäº Ïà®ÍπÄ
                $("button[name='statusChangeBtn']").hide(); // ÏÉÅÌÉú Î≥ÄÍ≤Ω Î≤ÑÌäº Ïà®ÍπÄ
                $("button[name='readTaskModify']").show(); //ÏàòÏ†ï Î≤ÑÌäº Î≥¥ÏûÑ
                $("button[name='readTaskDelete']").show(); //ÏÇ≠Ï†ú Î≤ÑÌäº Î≥¥ÏûÑ
                $("div[name='taskDetailsArea']").html( $("div[name='taskDetails']")); //ÏóÖÎ¨¥ ÏÉÅÏÑ∏Î≥¥Í∏∞Ï∞Ω Ïù¥Îèô

                $("div[name='taskDetails']").hide(); //Ïà®ÍπÄ
                $("div[name='history']").hide(); //Ïà®ÍπÄ

                $("button[name='readTaskModify-save']").text("ÏàòÏ†ï");
                $("button[name='readTaskModify-save']").attr("name","readTaskModify"); //inputÌÉúÍ∑∏ nameÏÜçÏÑ±ÎèÑ Î≥ÄÍ≤Ω
                $("input[name='readTaskTitle']").attr("readonly",true); //readonlyÏÜçÏÑ± false
                $("select[name='readTaskStatus']").removeAttr("disabled");

                $("input[name='readResponsibleMember']").show();
                $("select[name='modifyresponsibleMember']").hide();

                $("div[name='readTaskContent']").show();
                $("div[name='readTaskContent']").html($("div[name='modifyContent'] div.note-editable").html());
                $("div[name='modifyContent']").hide();

                $("div[name='mainContent']").html(mainList); //Î©îÏù∏ÏΩòÌÖêÏ∏†Í≥µÍ∞ÑÏóê Î©îÏù∏Î¶¨Ïä§Ìä∏ Ïù¥Îèô
            });

            //ÏóÖÎ¨¥ Ï†úÎ™©ÏùÑ ÎàåÎ†ÄÏùÑÎïå (ÏóÖÎ¨¥ÎÇ¥Ïö© Î≥¥ÏùºÏòàÏ†ï)
            $(document).on("click","td[name='readTask']",function (e){
                e.preventDefault();
                var tid = $(this).data("tid");
                var type = [[${pageRequestDTO.type}]];

                if(type =='d'){
                    //ÏÇ≠Ï†úÎêú ÏóÖÎ¨¥ ÌÉ≠ÏóêÏÑú ÏóÖÎ¨¥ ÏùΩÍ∏∞ ÎàåÎ†ÄÏùÑ Ïãú
                    alert("ÏÇ≠Ï†úÎêú ÏóÖÎ¨¥Îäî ÏùΩÍ∏∞ Î∂àÍ∞ÄÏûÖÎãàÎã§. Í¥ÄÎ¶¨ÏûêÏóêÍ≤å Î¨∏ÏùòÌïòÏÑ∏Ïöî.");
                }else{

                    $.ajax({
                        url:'/task/view',
                        type:'post',
                        data:{'tid':tid},
                        success:function (result){
                            console.log(result);
                            readTask(result);
                            readReply(tid)
                        }
                    });
                }
            });

            //ÏóÖÎ¨¥ ÏùΩÍ∏∞ Ìï®Ïàò
            function readTask(result){

                var currentUser = [[${#authentication.principal}]];
                var taskDetails = $("div[name='taskDetails']"); //ÏóÖÎ¨¥ ÏÉÅÏÑ∏Î≥¥Í∏∞ Ï∞Ω

                var selectStatus = $("select[name='readTaskStatus']");

                $("input[name='readTaskTid']").val(result.tid);
                $("input[name='readTaskTitle']").val(result.taskTitle);
                $("input[name='readTaskWriter']").val(result.taskWriter);
                $("input[name='readResponsibleMember']").val(result.responsibleMember);
                $("input[name='readTaskRegDate']").val(result.regDate);
                selectStatus.val(result.status);
                $("div[name='readTaskContent']").html(result.taskContent);

                PrevStatus = $("select[name='readTaskStatus']").val(); //ÏÉÅÌÉú ÏûÑÏãú Ï†ÄÏû• (Î≥ÄÍ≤ΩÏ†Ñ)

                if(currentUser.uid != result.taskWriter){
                    $("button[name='readTaskModify']").hide();
                    $("button[name='readTaskDelete']").hide();
                }
                taskDetails.show();

                $("div[name='mainContent']").html(taskDetails); //Î©îÏù∏ ÏΩòÌÖêÏ∏†Ï™ΩÏóê ÎÑ£Ïùå
            }
        });

        //ÎåìÍ∏Ä ÏùΩÏñ¥Ïò§Í∏∞
        function readReply(tid){

            //ÎåìÍ∏ÄÍ≥º ÎåÄÎåìÍ∏Ä Í∞ÄÏ†∏Ïò¥
            $.ajax({
                url:'/task/replyList',
                type:'post',
                data:{'tid':tid},
                success:async function (result){

                    var str ='';
                    if(result != null){
                        for(var i=0;i<result.length;i++){
                            var rereplyStr = await readReReply(result[i]);

                            str+= '<div class="media-body" name="reply" data-rid="'+result[i].rid+'">'+
                                '<div class="d-sm-flex justify-content-between mb-2">' +
                                '<h5 class="mb-sm-0">'+ result[i].uid +'<small class="text-muted ml-3">'+result[i].regDate+'</small></h5>' +
                                '<div class="media-reply__link">'+
                                '<button class="btn btn-transparent p-0 mr-3"><i class="fa fa-thumbs-up"></i></button>' +
                                '<button class="btn btn-transparent p-0 mr-3"><i class="fa fa-thumbs-down"></i></button>' +
                                '<button class="btn btn-transparent p-0 ml-3 font-weight-bold" name="re-reply">üó®Ô∏èÎåìÍ∏Ä</button>' +
                                '</div></div>' +
                                '<p>'+result[i].replyContent+'</p>'+
                                '<div name="re-reply">';

                            str+= rereplyStr; //ÎåÄÎåìÍ∏Ä

                            str+= '</div></div>'+
                                '<div class="card" name="re-replyInput" style="display: none;">'+
                                '<div class="card-body" style="background-color: whitesmoke;">' +
                                '<form action="#" class="form-profile" name="re-replyForm">'+
                                '<div class="form-group" style="position: relative";>'+
                                '<div class="popup">This is a popup div.</div>'+
                                '<textarea class="form-control" name="re-replyText" id="textarea" cols="30" rows="2" placeholder="ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî"></textarea>' +
                                '</div>' +
                                '<div class="d-flex align-items-center">' +
                                '<input type="hidden" name="parentReplyRid" value="'+result[i].rid+'">'+
                                '<button class="btn btn-primary px-3 ml-4" name="registerRe-ReplyBtn">Îì±Î°ù</button>'+
                                '</div>'+
                                '</form>'+
                                '</div>'+
                                '</div>'+
                                '</div>';
                        }
                        $("div[name='replyList']").html(str);
                    }
                }
            });
        } //ÎåìÍ∏Ä ÏùΩÏñ¥Ïò§Í∏∞ ÎÅù

        async function readReReply(result) {
            var rid = result.rid;
            var resultStr = '';

            try {
                var reply = await $.ajax({
                    url: '/task/rereplyList',
                    data: {'rid': rid},
                    type: 'post'
                });

                if (reply != null) {
                    for (var i = 0; i < reply.length; i++) {

                        resultStr += '<div class="media-body"style="margin-left: 3rem; background-color:aliceblue; padding: 10px; " name="re-reply" data-rid="' + reply[i].rrid + '">' +
                            '<div class="d-sm-flex justify-content-between mb-2">' +
                            '<h5 class="mb-sm-0">' + reply[i].uid + '<small class="text-muted ml-3">' + reply[i].regDate + '</small></h5>' +
                            '<div class="media-reply__link">' +
                            '<button class="btn btn-transparent p-0 mr-3"><i class="fa fa-thumbs-up"></i></button>' +
                            '<button class="btn btn-transparent p-0 mr-3"><i class="fa fa-thumbs-down"></i></button>' +
                            '</div></div>' +
                            '<p>' + reply[i].replyText + '</p></div>';
                    }
                    return resultStr;
                }
            } catch (error) {
                console.error("ÏóêÎü¨ Î∞úÏÉù:", error);
                throw error;
            }
        }

        $(document).on("click","button[name='re-reply']",function (e){
            //ÎåÄÎåìÍ∏Ä Îã¨Í∏∞ Î≤ÑÌäºÏù¥ ÎàåÎ†∏ÏùÑ Îïå
            e.preventDefault();
            $(this).text("Ï∑®ÏÜå");
            $(this).attr("name","re-reply-close");
            $(this).closest("div[name='reply']").next("div[name='re-replyInput']").show();
        });

        $(document).on("click","button[name='re-reply-close']",function (e){
            //ÎåÄÎåìÍ∏Ä Îã¨Í∏∞ Ï∑®ÏÜå Î≤ÑÌäºÏù¥ ÎàåÎ†∏ÏùÑ Îïå
            e.preventDefault();
            $(this).text("üó®Ô∏èÎåìÍ∏Ä");
            $(this).attr("name","re-reply");
            $(this).closest("div[name='reply']").next("div[name='re-replyInput']").hide();
        });

        $(document).on("click","button[name='regusterReplyBtn']",function (e){
            //ÎåìÍ∏Ä Îì±Î°ù Î≤ÑÌäºÏù¥ ÎàåÎ†∏ÏùÑ Îïå

            e.preventDefault();

            var replyContent= $("textarea[name='replyText']").val();

            if(replyContent.length > 0 && replyContent != null){

                var readTaskTid = $("input[name='readTaskTid']").val();
                var uid = $("input[name='uid']").val();

                $.ajax({
                    url:'/task/register/reply',
                    type:'post',
                    data:{'readTaskTid':readTaskTid,
                        'uid':uid,
                        'replyContent':replyContent
                    } ,
                    success:function (result){
                        if(result != null){
                            alert("ÎåìÍ∏ÄÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.");
                            $("textarea[name='replyText']").val(''); //ÎåìÍ∏Ä ÏûÖÎ†•Ï∞Ω ÎπÑÏõåÎë†
                            readReply(readTaskTid); //ÎåìÍ∏Ä Î¶¨Ïä§Ìä∏ Î∂àÎü¨Ïò¥
                        }
                    }
                }); //ajaxÎÅù
            }else{
                alert("ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!");
                $("textarea[name='replyText']").focus();
            }
        });

        $(document).on("click","button[name='registerRe-ReplyBtn']",function (e){
            //ÎåÄÎåìÍ∏Ä Îì±Î°ù Î≤ÑÌäºÏù¥ ÎàåÎ†∏ÏùÑ Îïå
            e.preventDefault();
            var readTaskTid = $("input[name='readTaskTid']").val();

            var replyText = $(this).parent().prev().children("textarea[name='re-replyText']").val();

            if(replyText.length > 0 && replyText != null){

                var parentRid =$(this).prev("input[name='parentReplyRid']").val();
                var uid = [[${#authentication.principal.uid}]];

                $.ajax({
                    url:'/task/register/rereply',
                    type:'post',
                    data:{'parentRid': parentRid,
                        'uid':uid,
                        'replyText':replyText
                    },
                    success:function (result){
                        if(result){
                            alert("ÎåìÍ∏ÄÏù¥ Îì±Î°ùÎêòÏóàÏäµÎãàÎã§.");
                            $("button[name='registerRe-ReplyBtn']").parent().prev().children("textarea[name='re-replyText']").val('');
                            readReply(readTaskTid);
                        }
                    }
                });

            }else{
                alert("ÎåìÍ∏ÄÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî!");
                $(this).focus();
            }
        });


        //ÏóÖÎ¨¥ ÏÉÅÏÑ∏Î≥¥Í∏∞ -> ÏÉÅÌÉúÎ≥ÄÍ≤Ω ÏÖÄÎ†âÌä∏ Î∞ïÏä§Ïóê Î≥ÄÍ≤ΩÏù¥ Í∞êÏßÄÎêòÎ©¥
        $("select[name='readTaskStatus']").change(function (){

            //Î≥ÄÍ≤Ω Î≤ÑÌäº ÎÖ∏Ï∂ú
            $("button[name='statusChangeBtn']").show();
        })

        //ÏóÖÎ¨¥Ïùò ÏÉÅÏÑ∏Î≥¥Í∏∞ -> ÏÉÅÌÉú Î≥ÄÍ≤Ω Î≤ÑÌäºÏù¥ ÎàåÎ†∏ÏùÑ Îïå
        $("button[name='statusChangeBtn']").on("click",function (e){
            e.preventDefault();

            var tid = $("input[name='readTaskTid']").val()+"";
            var status = $("select[name='readTaskStatus']").val(); //Î∞îÎÄêÏÉÅÌÉú
            var uid = [[${#authentication.principal.uid}]];
            var prevStatus = PrevStatus; //Ïù¥Ï†Ñ ÏÉÅÌÉú
            //Ìï¥Îãπ ÏóÖÎ¨¥Ïùò ÏÉÅÌÉúÎ•º Î≥ÄÍ≤Ω
            $.ajax({
                url:'/task/changestatus',
                data:{'tid':tid,
                    'status':status,
                    'uid' : uid,
                    'prevStatus':prevStatus
                },
                type:'post',
                success:function(result){

                    location.reload();
                }
            });
        });

        //ÏÉÅÌÉú Î≥ÄÍ≤ΩÏù¥Î†•Î≥¥Í∏∞ Î≤ÑÌäºÏù¥ ÎàåÎ†∏Îã§Î©¥
        $(document).on("click","button[name='showHistoryBtn']",function (e){
            e.preventDefault();
            $(this).hide();
            $("button[name='closeHistoryBtn']").show();

            var tid =  $("input[name='readTaskTid']").val();

            $.ajax({
                url:'/task/history',
                type:'post',
                data:{'tid':tid},
                success:function (result){
                    console.log(result);
                    showHistory(result);
                }
            });
        });

        $(document).on("click","button[name='closeHistoryBtn']",function (e){
            //ÏÉÅÌÉú Ïù¥Î†• Î≥¥Í∏∞ Îã´Í∏∞Î≤ÑÌäºÏù¥ ÎàåÎ†∏Îã§Î©¥
            e.preventDefault();
            $(this).hide();
            $("button[name='showHistoryBtn']").show();

            $("div[name='history']").hide();
        });

        function showHistory(result){
            var str ='';

            if(result==null){

                str = "<b>ÏÉÅÌÉú Î≥ÄÍ≤Ω Ïù¥Î†•Ïù¥ Ï°¥Ïû¨ÌïòÏßÄ ÏïäÏäµÎãàÎã§.</b>";

            }else {

                for(var i=0;i<result.length;i++){

                    var prevStatus;
                    var status;

                    if(result[i].status=='TODO'){
                        status='Ìï†Ïùº';
                    }else if(result[i].status=='INPROGRESS'){
                        status='ÏßÑÌñâÏ§ë';
                    }else if(result[i].status=='BLOCK'){
                        status='Î≥¥Î•ò';
                    }else if(result[i].status=='DONE'){
                        status='ÏôÑÎ£å';
                    }

                    if(result[i].prevStatus=='TODO'){
                        prevStatus='Ìï†Ïùº';
                    }else if(result[i].prevStatus=='INPROGRESS'){
                        prevStatus='ÏßÑÌñâÏ§ë';
                    }else if(result[i].prevStatus=='BLOCK'){
                        prevStatus='Î≥¥Î•ò';
                    }else if(result[i].prevStatus=='DONE'){
                        prevStatus='ÏôÑÎ£å';
                    }

                    str += "<tr><th>"+result[i].modDate+"</th><td>"+prevStatus+"</td>"
                        +"<td>"+status+"</span></td>"
                        +"<td>"+result[i].uid+"</td></tr>";
                }
            }
            $("tbody[name='historyBody']").html(str);
            $("div[name='history']").show();
        };

        $(document).on("click","button[name='registerBtn']",function (e){
            //ÏóÖÎ¨¥ Îì±Î°ù Î≤ÑÌäº ÎàåÎ†ÄÏùÑÎïå (ÏóÖÎ¨¥ Îì±Î°ù Î™®Îã¨ÏóêÏÑú Îì±Î°ù Î≤ÑÌäº)
            e.preventDefault();

            if($("select[name='responsibleMember']").val() == null || $("select[name='responsibleMember']").val().length<=0){
                alert("Îã¥ÎãπÏûêÎ•º ÏßÄÏ†ïÌï¥Ï£ºÏÑ∏Ïöî");
                $("select[name='responsibleMember']").focus();
                return;
            }
            if($("input[name='taskTitle']").val().length<=0){
                alert("ÏóÖÎ¨¥ Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî");
                $("input[name='taskTitle']").focus();
                return;
            }

            var taskForm = $("form[name='taskForm']");
            var htmlStr = $(".modal_ div.note-editable").html();

            $("input[name='taskContent']").val(htmlStr);

            taskForm.submit();

        })

        $(document).on("click","button[name='readTaskModify']",function (e){
            //ÏóÖÎ¨¥ ÏàòÏ†ï Î≤ÑÌäºÏù¥ ÎàåÎ†∏ÏùÑ Îïå (ÏûëÏÑ±ÏûêÎßå ÏàòÏ†ï Í∞ÄÎä•)
            e.preventDefault();

            $(this).text("Ï†ÄÏû•"); //ÏàòÏ†ï Î≤ÑÌäºÏùÑ Ï†ÄÏû• Î≤ÑÌäºÏúºÎ°ú Î∞îÍøà
            $(this).attr("name","readTaskModify-save"); //inputÌÉúÍ∑∏ nameÏÜçÏÑ±ÎèÑ Î≥ÄÍ≤Ω
            $("input[name='readTaskTitle']").attr("readonly",false); //readonlyÏÜçÏÑ± false
            $("select[name='readTaskStatus']").attr("disabled","disabled"); // ÏÉÅÌÉúÎ≥ÄÍ≤Ω select disabled

            $("input[name='readResponsibleMember']").hide(); //Îã¥ÎãπÏûê input Î∞ïÏä§ hide
            $("select[name='modifyresponsibleMember']").show(); //Îã¥ÎãπÏûê select Î∞ïÏä§ show
            var readTaskContent = $("div[name='readTaskContent']").html(); //ÏóÖÎ¨¥ÎÇ¥Ïö© Ï†ÄÏû•
            $("div[name='readTaskContent']").hide(); //ÎÇ¥Ïö© divÏà®ÍπÄ

            $("div[name='modifyContent']").show(); //ÏóêÎîîÌÑ∞ Î≥¥ÏûÑ
            $("div[name='modifyContent'] div.note-editable").html(readTaskContent); //ÏóêÎîîÌÑ∞Ïóê Ï†ÄÏû•Ìïú ÏóÖÎ¨¥ÎÇ¥Ïö© ÏÇΩÏûÖ

        })


        $(document).on("click","button[name='readTaskModify-save']" ,function (e){
            //ÏóÖÎ¨¥ ÏàòÏ†ïÌõÑ Ï†ÄÏû• Î≤ÑÌäºÏù¥ ÎàåÎ†∏ÏùÑ Îïå
            e.preventDefault();

            if( $("select[name='modifyresponsibleMember']").val() == ''){
                alert("Îã¥ÎãπÏûêÎ•º ÏßÄÏ†ïÌï¥Ï£ºÏÑ∏Ïöî");
                return;
            }
            var tid = $("input[name='readTaskTid']").val(); // ÏóÖÎ¨¥ Î≤àÌò∏
            var taskTitle =  $("input[name='readTaskTitle']").val();
            var responsibleMember =  $("select[name='modifyresponsibleMember']").val();
            var taskContent =$("div[name='modifyContent'] div.note-editable").html();

            $.ajax({
                url:'/task/modify',
                data:{'tid':tid,
                    'taskTitle':taskTitle,
                    'responsibleMember':responsibleMember,
                    'taskContent':taskContent
                },
                type:'post',
                success:function (result){

                    if(result == 'success'){

                        $("button[name='readTaskModify-save']").text("ÏàòÏ†ï");
                        $("button[name='readTaskModify-save']").attr("name","readTaskModify"); //inputÌÉúÍ∑∏ nameÏÜçÏÑ±ÎèÑ Î≥ÄÍ≤Ω
                        $("input[name='readTaskTitle']").attr("readonly",true); //readonlyÏÜçÏÑ± false
                        $("select[name='readTaskStatus']").removeAttr("disabled");

                        $("input[name='readResponsibleMember']").show();
                        $("select[name='modifyresponsibleMember']").hide();

                        $("div[name='readTaskContent']").show();
                        $("div[name='readTaskContent']").html($("div[name='modifyContent'] div.note-editable").html());
                        $("div[name='modifyContent']").hide();

                        alert("ÏóÖÎ¨¥Î•º ÏàòÏ†ïÌñàÏäµÎãàÎã§.");

                    }else{
                        alert("ÏàòÏ†ï Ïã§Ìå®!");
                    }
                }
            });
        });

        $(document).on("click","button[name='readTaskDelete']",function (e){
            e.preventDefault();

            if(confirm("Ìï¥Îãπ ÏóÖÎ¨¥Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?")){
                var tid = $("input[name='readTaskTid']").val(); //ÏóÖÎ¨¥Î≤àÌò∏

                $.ajax({
                    url:'/task/delete',
                    data:{'tid':tid},
                    type:'delete',
                    success:function (result){
                        if(result == 'success'){
                            alert("ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.");
                            location.reload();
                        }
                    }
                });
            }
        });


        //ÌéòÏù¥Ïßï Î≤ÑÌäºÏùÑ ÎàåÎ†ÄÏùÑ Îïå
        $("a.page-link").on("click", function (event) {

            event.preventDefault(); // ÎßÅÌÅ¨Ïùò Í∏∞Î≥∏ ÎèôÏûëÏùÑ Ï§ëÎã®Ìï©ÎãàÎã§.

            var pageNum = $(this).data("num");
            var mid = [[${mid}]];
            var type = [[${pageRequestDTO.type}]];
            var keyword = [[${pageRequestDTO.keyword}]];

            if(type != null && keyword!=null){
                var url = '/task/list/'+[[${pid}]]+'/'+[[${projectName}]]+'?page='+pageNum+'&type='+type+'&keyword='+keyword;
            }else{
                var url = '/task/list/'+[[${pid}]]+'/'+[[${projectName}]]+'?page='+pageNum;
            }
            window.location.href = url; // ÏÉàÎ°úÏö¥ URLÎ°ú Ïù¥ÎèôÌï©ÎãàÎã§.
        });

    </script>

</th:block>
</html>